<?php

/**
 * @file
 * An interface to the API for APPrise Mobile Clients.
 */

/**
 * Define constants.
 */

// Set the API version.
define('APPRISE_MOBILE_API_VERSION', '2.0.0');

// Set the path to the API.
define('APPRISE_MOBILE_API_PATH', drupal_get_path('module', 'apprise_mobile_api') . '/SwaggerClient-php');

// For PHP < 5.5.  See http://php.net/manual/en/function.curl-file-create.php.
if (!function_exists('curl_file_create')) {
  function curl_file_create($filename, $mimetype = '', $postname = '') {
    return "@$filename;filename=" . ($postname ?: basename($filename)) . ($mimetype ? ";type=$mimetype" : '');
  }
}

/**
 * Implements hook_menu().
 */
function apprise_mobile_api_menu() {
  $items = array();

  $items['admin/config/content/apprise-mobile-api'] = array(
    'title' => 'APPrise Mobile API',
    'description' => 'Adjust APPrise Mobile API settings.',
    'file' => 'apprise_mobile_api.admin.inc',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('apprise_mobile_api_admin_settings'),
    'access arguments' => array('administer site configuration'),
  );

  return $items;
}

/**
 * Implements hook_cron().
 */
function apprise_mobile_api_cron() {
  $variables = apprise_mobile_api_get_variables();

  if (!$run = $variables['execute']) {
    $cron = $variables['cron'];
    switch ($cron) {
      case 1:
        $run = TRUE;
        break;

      case 2:
        // Only run cron between 12:00 and 1:00 AM.
        // This works only if cron runs hourly or
        // within this time frame (recommended).
        $run = !format_date(time(), 'custom', 'G');
        break;

      default:
        $run = FALSE;
    }
  }

  if ($run) {
    try {
      // Retrieve all relevant bundles.
      $bundles = array();
      foreach ($variables['types'] as $type => $value) {
        if ($value) {
          $bundles[] = $type;
        }
      }

      // Check for content that was added since 'apprise_mobile_api_days' ago.
      $days_ago = '-' . variable_get('apprise_mobile_api_days', 1) . ' day';
      $time = strtotime($days_ago);
      foreach ($bundles as $bundle) {
        // Check for all relevant bundle content that was added since 'apprise_mobile_api_days' ago.
        $rows = db_query("SELECT nid FROM {node} WHERE type = :bundle AND created >= :time", array(
          ':bundle' => $bundle,
          ':time' => $time,
        ));
        foreach ($rows as $row) {
          $node = node_load($row->nid);
          // Only send if checked.
          if (!empty($node->field_apprise_mobile_api_send[LANGUAGE_NONE][0]['value'])) {
            // Retrieve the content.
            $content = check_markup($node->body[LANGUAGE_NONE][0]['value'], $node->body[LANGUAGE_NONE][0]['format']);

            // Generate a curl compatible file.
            $filename = variable_get('file_temporary_path', '/tmp') . '/' . time() . '.html';
            $file = curl_file_create($filename, 'text/html');

            // Base64 encode images.
            preg_match_all('|<img.*src="(.*)".*>|U', $content, $matches);
            if (isset($matches[1])) {
              foreach ($matches[1] as $path) {
                $type = pathinfo($path, PATHINFO_EXTENSION);
                $data = file_get_contents($path);
                $base64 = 'data:image/' . $type . ';base64,' . base64_encode($data);
                $content = str_replace($path, $base64, $content);
              }
            }

            // Write the content to file.
            if ($fp = fopen($filename, 'w')) {
              fwrite($fp, $content);
              fclose($fp);
            }

            // Generate values to pass to the API.
            $date_format = 'Y-m-d\TH:i:s';
            $publish_date = format_date($node->created, 'custom', $date_format, 'UTC');
            $web_url = NULL;
            $share = $node->field_apprise_mobile_api_share[LANGUAGE_NONE][0]['value'];
            $default_timezone = date_default_timezone_get();
            date_default_timezone_set('UTC');
            $post_date = format_date(strtotime($node->field_apprise_mobile_api_post[LANGUAGE_NONE][0]['value']), 'custom', $date_format);
            $unpost_date = format_date(strtotime($node->field_apprise_mobile_api_unpost[LANGUAGE_NONE][0]['value']), 'custom', $date_format);
            date_default_timezone_set($default_timezone);
            $notes_enabled = 'false';
            $notify = 'true';
            $secure = 'false';
            $include_in_feed = 'true';
            $display_thumbnail = 'true';
            $content_folder = $node->field_apprise_mobile_api_folder[LANGUAGE_NONE][0]['value'];
            $access_groups = $node->field_apprise_mobile_api_group[LANGUAGE_NONE][0]['value'];
            $integration_id = NULL;
            $integration_type = NULL;
            $values = array(
              'title' => $node->title,
              'file' => $file,
              'publishDate' => $publish_date,
              'webUrl' => $web_url,
              'share' => $share,
              'postDate' => $post_date,
              'unpostDate' => $unpost_date,
              'notesEnabled' => $notes_enabled,
              'notify' => $notify,
              'secure' => $secure,
              'includeInFeed' => $include_in_feed,
              'displayThumbnail' => $display_thumbnail,
              'contentFolder' => $content_folder,
              'accessGroups' => $access_groups,
              'integrationId' => $integration_id,
              'integrationType' => $integration_type,
            );

            // Post the request.
            apprise_mobile_api_post('contents', $values);

            // Remove temporary file.
            unlink($filename);
          }
        }
      }
    } catch (Exception $e) {
      $msg = 'Exception when calling apprise_mobile_api_post: ' . $e->getMessage();
      if (variable_get('error_level', 0)) {
        drupal_set_message($msg, 'error');
      }
      watchdog('apprise_mobile_api', $msg, array(), WATCHDOG_ERROR);
    }
  }
}

/**
 * Get content via an API request.
 */
function apprise_mobile_api_get($call = 'contents') {
  $content = array();

  try {
    // Build the request URL.
    $variables = apprise_mobile_api_get_variables();
    $base_url = $variables['base_url'];
    $params = array(
      'limit' => $variables['limit'],
      'offset' => $variables['offset'],
      'code' => $variables['key'],
    );
    $url = $base_url . '/' . $call . '?' . http_build_query($params);

    // Send the request.
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
    curl_setopt($ch, CURLOPT_ENCODING, '');
    curl_setopt($ch, CURLOPT_MAXREDIRS, 10);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    curl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1);
    curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.13) Gecko/20080311 Firefox/2.0.0.13');
    $json_response = curl_exec($ch);

    if ($results = json_decode($json_response)) {
      // Build array from results.
      foreach ($results as $result) {
        $content[$result->_id] = isset($result->title) ? $result->title : $result->name;
      }
    }

    // Debug messages.
    if (variable_get('apprise_mobile_api_debug', 0)) {
      $msg = 'Request: ' . $url;
      if (variable_get('error_level', 0)) {
        drupal_set_message($msg, 'error');
      }
      watchdog('apprise_mobile_api', $msg);
      $msg = 'Response: ' . print_r($results, TRUE);
      if (variable_get('error_level', 0)) {
        drupal_set_message($msg, 'error');
      }
      watchdog('apprise_mobile_api', $msg);
    }
  } catch (Exception $e) {
    $msg = 'Exception when processing the request: ' . $e->getMessage();
    if (variable_get('error_level', 0)) {
      drupal_set_message($msg, 'error');
    }
    watchdog('apprise_mobile_api', $msg, array(), WATCHDOG_ERROR);
  }

  return $content;
}

/**
 * Post content via an API request.
 */
function apprise_mobile_api_post($call = 'contents', $values = array()) {
  try {
    // Build the request URL.
    $variables = apprise_mobile_api_get_variables();
    $base_url = $variables['base_url'];
    $code = $variables['key'];
    $url = $base_url . '/' . $call . '?code=' . $code;
    $headers = array('content-type: multipart/form-data');
    $fields = http_build_query($values);

    // Post the request.
    $msg = '';
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $values);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
    curl_setopt($ch, CURLOPT_ENCODING, '');
    curl_setopt($ch, CURLOPT_MAXREDIRS, 10);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    curl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1);
    curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.13) Gecko/20080311 Firefox/2.0.0.13');
    $json_response = curl_exec($ch);
    if ($response = json_decode($json_response)) {
      if (isset($response->originalResponse)) {
        $response = json_decode($response->originalResponse);
        $msg = $response->code . ': ' . $response->message;
      }
      elseif (isset($response->results->errors)) {
        $errors = array();
        foreach ($response->results->errors as $error) {
          $errors[] = $error->code . ': ' . $error->message;
        }
        $msg = implode(', ', $errors);
      }
      else {
        $msg = print_r($response, TRUE);
      }
    }
    curl_close($ch);

    // Response message.
    if (variable_get('error_level', 0)) {
      drupal_set_message($msg);
    }
    watchdog('apprise_mobile_api', $msg);

    // Debug messages.
    if (variable_get('apprise_mobile_api_debug', 0)) {
      $msg = 'Request: ' . print_r($values, TRUE);
      if (variable_get('error_level', 0)) {
        drupal_set_message($msg);
      }
      watchdog('apprise_mobile_api', $msg);
      $msg = 'Response: ' . print_r($json_response, TRUE);
      if (variable_get('error_level', 0)) {
        drupal_set_message($msg);
      }
      watchdog('apprise_mobile_api', $msg);
    }
  } catch (Exception $e) {
    $msg = 'Exception when processing the request: ' . $e->getMessage();
    if (variable_get('error_level', 0)) {
      drupal_set_message($msg, 'error');
    }
    watchdog('apprise_mobile_api', $msg, array(), WATCHDOG_ERROR);
  }
}

/**
 * Get variables.
 */
function apprise_mobile_api_get_variables() {
  $host = variable_get('apprise_mobile_api_host', 'https://api.theemployeeapp.com');
  $parsed_url = parse_url($host);
  if (!empty($parsed_url['host']) and !defined('APPRISE_MOBILE_API_HOST')) {
    define('APPRISE_MOBILE_API_HOST', $host);
  }
  $base_url = $host . '/v' . (int)APPRISE_MOBILE_API_VERSION;
  if ($mode = variable_get('apprise_mobile_api_mode', 0)) {
    $key = variable_get('apprise_mobile_api_prod_key', '');
    $prefix = variable_get('apprise_mobile_api_prod_prefix', '');
  }
  else {
    $key = variable_get('apprise_mobile_api_test_key', '');
    $prefix = variable_get('apprise_mobile_api_test_prefix', '');
  }
  $types = variable_get('apprise_mobile_api_types', array());
  $limit = variable_get('apprise_mobile_api_limit', 10);
  $offset = variable_get('apprise_mobile_api_offset', 0);
  $cron = variable_get('apprise_mobile_api_cron', 0);
  $execute = variable_get('apprise_mobile_api_execute', 0);
  return array(
    'host' => $host,
    'base_url' => $base_url,
    'mode' => $mode,
    'key' => $key,
    'prefix' => $prefix,
    'types' => $types,
    'limit' => $limit,
    'offset' => $offset,
    'cron' => $cron,
    'execute' => $execute,
  );
}
